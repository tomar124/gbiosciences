{% if mode == 'demo' %}
    {% set card_template = random(['template1', 'template2']) %}
{% endif %}

<link rel="stylesheet" type="text/css" href="{{ b }}catalog/view/theme/default/stylesheet/esp_common.css">
<script type="text/javascript" src="{{ b }}catalog/view/javascript/esp_dbi.js" defer></script>
{% if card_template == 'template1' %}
    <link rel="stylesheet" type="text/css" href="{{ b }}catalog/view/theme/default/stylesheet/esp_template1.css">
{% elseif card_template == 'template2' %}
    <link rel="stylesheet" type="text/css" href="{{ b }}catalog/view/theme/default/stylesheet/esp_template2.css">
{% endif %}


{% if transaction_mode == 0 %}
    <div class="alert alert-warning alert-testmode">
        Test mode enabled. You can use a <a target="_blank" href="https://stripe.com/docs/testing#cards">Stripe test card</a>
        <br/>
        For example, <i>4242 4242 4242 4242</i> or <i>4000 0000 0000 3220</i> to test 3D Secure 2 authentication.
        <br/><br/>

        {% if mode == 'demo' %}
            For demo purpose, credit card input template is chosen <b>randomly</b>. Refresh the page to see different templates.
            <br/><br/>
        {% endif %}

        Depending on your browser and device, Apple Pay, Google Pay or Microsoft Pay button can appear.
        <br/>
        Please note that some payment methods aren't activated and not presented here.
    </div>
{% endif %}



{% if checkout_type == 'payment_form' %}

    <div class="payment-types-tabs">
        <ul class="nav nav-tabs" role="tablist">
            <!-- Stored cards -->
            {% if use_stored_cards == '1' and storedcards|length > 0  %}
                <li class="nav-item custom-tab custom-tab-cards {{ storedcard_tab }}">
                    <a class="nav-link" id="storedcard-tab" data-value="storedcard" data-toggle="tab" href="#storedcard" role="tab" aria-controls="storedcard" aria-selected="true">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_cards2.png">
                        {{ text_storedcard }}
                    </a>
                </li>
            {% endif %}

            <!-- New card -->
            {% if paymenttype_creditcards or paymenttype_button %}
                <li class="nav-item custom-tab custom-tab-cards {{ creditcards_tab }}">
                    <a class="nav-link" id="newcard-tab" data-value="newcard" data-toggle="tab" href="#newcard" role="tab" aria-controls="newcard" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_cards2.png">
                        {{ text_newcard }}
                    </a>
                </li>
            {% endif %}

            <!-- iDEAL -->
            {% if paymenttype_ideal %}
                <li class="nav-item custom-tab {{ ideal_tab }}">
                    <a class="nav-link" id="ideal-tab" data-value="ideal" data-toggle="tab" href="#ideal" role="tab" aria-controls="ideal" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_ideal.png">
                    </a>
                </li>
            {% endif %}

            <!-- Giropay -->
            {% if paymenttype_giropay %}
                <li class="nav-item custom-tab {{ giropay_tab }}">
                    <a class="nav-link" id="giropay-tab" data-value="giropay" data-toggle="tab" href="#giropay" role="tab" aria-controls="giropay" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_giropay.png">
                    </a>
                </li>
            {% endif %}

            <!-- Bancontact -->
            {% if paymenttype_bancontact %}
                <li class="nav-item custom-tab {{ bancontact_tab }}">
                    <a class="nav-link" id="bancontact-tab" data-value="bancontact" data-toggle="tab" href="#bancontact" role="tab" aria-controls="bancontact" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_bancontact.png">
                    </a>
                </li>
            {% endif %}

            <!-- EPS -->
            {% if paymenttype_eps %}
                <li class="nav-item custom-tab {{ eps_tab }}">
                    <a class="nav-link" id="eps-tab" data-value="eps" data-toggle="tab" href="#eps" role="tab" aria-controls="eps" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_eps.png">
                    </a>
                </li>
            {% endif %}

            <!-- P24 -->
            {% if paymenttype_p24 %}
                <li class="nav-item custom-tab {{ p24_tab }}">
                    <a class="nav-link" id="p24-tab" data-value="p24" data-toggle="tab" href="#p24" role="tab" aria-controls="p24" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_p24.png">
                    </a>
                </li>
            {% endif %}

            <!-- Multibanco -->
            {% if paymenttype_multibanco %}
                <li class="nav-item custom-tab {{ multibanco_tab }}">
                    <a class="nav-link" id="multibanco-tab" data-value="multibanco" data-toggle="tab" href="#multibanco" role="tab" aria-controls="multibanco" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_multibanco.png">
                    </a>
                </li>
            {% endif %}

            <!-- Klarna -->
            {% if paymenttype_klarna %}
                <li class="nav-item custom-tab {{ klarna_tab }}">
                    <a class="nav-link" id="klarna-tab" data-value="klarna" data-toggle="tab" href="#klarna" role="tab" aria-controls="klarna" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_klarna.png">
                    </a>
                </li>
            {% endif %}

            <!-- WeChat -->
            {% if paymenttype_wechat %}
                <li class="nav-item custom-tab {{ wechat_tab }}">
                    <a class="nav-link" id="wechat-tab" data-value="wechat" data-toggle="tab" href="#wechat" role="tab" aria-controls="wechat" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_wechat.png">
                    </a>
                </li>
            {% endif %}

            <!-- Alipay -->
            {% if paymenttype_alipay %}
                <li class="nav-item custom-tab {{ alipay_tab }}">
                    <a class="nav-link" id="alipay-tab" data-value="alipay" data-toggle="tab" href="#alipay" role="tab" aria-controls="alipay" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_alipay.png">
                    </a>
                </li>
            {% endif %}

            <!-- FPX -->
            {% if paymenttype_fpx %}
                <li class="nav-item custom-tab {{ fpx_tab }}">
                    <a class="nav-link" id="fpx-tab" data-value="fpx" data-toggle="tab" href="#fpx" role="tab" aria-controls="fpx" aria-selected="false">
                        <img src="{{ b }}catalog/view/theme/default/image/logo_fpx.png">
                    </a>
                </li>
            {% endif %}
        </ul>


        <div class="tab-content" id="stripeproTabContent">
            <!-- Stored cards -->
            {% if use_stored_cards == '1' and storedcards|length > 0  %}
                <div class="tab-pane {{ storedcard_tab }}" id="storedcard" role="tabpanel" aria-labelledby="home-tab">
                    <select id="selectStoredcards" class="form-control">
                        {% for card in storedcards %}
                            <option value="{{ card.id }}">{{ card.brand }} ****{{ card.last4 }} ({{ card.exp_month }}/{{ card.exp_year }})</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

            <!-- New card -->
            {% if paymenttype_creditcards or paymenttype_button %}
                <div class="tab-pane {{ creditcards_tab }}" id="newcard" role="tabpanel" aria-labelledby="profile-tab">
                    <div class="payment-form-wrapper">
                        <form id="payment-form">
                            {% if paymenttype_button %}
                                <div id="payment-request-button"></div>
                            {% endif %}

                            {% if paymenttype_creditcards %}
                                {% if card_template == 'template1' %}
                                    <div class="cell example example1" id="example-1">
                                        <fieldset>
                                            <legend class="card-only" data-tid="elements_examples.form.pay_with_card">{{ text_enter_card_detail }}</legend>
                                            <legend class="payment-request-available" data-tid="elements_examples.form.enter_card_manually">{{ text_or_enter_card_detail }}</legend>
                                            <div class="container">
                                                <div id="example1-card"></div>
                                            </div>
                                        </fieldset>

                                        <div class="error" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17">
                                                <path class="base" fill="#000" d="M8.5,17 C3.80557963,17 0,13.1944204 0,8.5 C0,3.80557963 3.80557963,0 8.5,0 C13.1944204,0 17,3.80557963 17,8.5 C17,13.1944204 13.1944204,17 8.5,17 Z"></path>
                                                <path class="glyph" fill="#FFF" d="M8.5,7.29791847 L6.12604076,4.92395924 C5.79409512,4.59201359 5.25590488,4.59201359 4.92395924,4.92395924 C4.59201359,5.25590488 4.59201359,5.79409512 4.92395924,6.12604076 L7.29791847,8.5 L4.92395924,10.8739592 C4.59201359,11.2059049 4.59201359,11.7440951 4.92395924,12.0760408 C5.25590488,12.4079864 5.79409512,12.4079864 6.12604076,12.0760408 L8.5,9.70208153 L10.8739592,12.0760408 C11.2059049,12.4079864 11.7440951,12.4079864 12.0760408,12.0760408 C12.4079864,11.7440951 12.4079864,11.2059049 12.0760408,10.8739592 L9.70208153,8.5 L12.0760408,6.12604076 C12.4079864,5.79409512 12.4079864,5.25590488 12.0760408,4.92395924 C11.7440951,4.59201359 11.2059049,4.59201359 10.8739592,4.92395924 L8.5,7.29791847 L8.5,7.29791847 Z"></path>
                                            </svg>
                                            <span class="message"></span>
                                        </div>
                                    </div>
                                {% elseif card_template == 'template2' %}
                                    <div class="cell example example2" id="example-2">
                                        <div class="form">
                                            <div class="row">
                                                <div class="field">
                                                    <div id="example2-card-number" class="input empty"></div>
                                                    <label for="example2-card-number" data-tid="elements_examples.form.card_number_label">{{ text_card_number }}</label>
                                                    <div class="baseline"></div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="field half-width">
                                                    <div id="example2-card-expiry" class="input empty"></div>
                                                    <label for="example2-card-expiry" data-tid="elements_examples.form.card_expiry_label">{{ text_expiration }}</label>
                                                    <div class="baseline"></div>
                                                </div>
                                                <div class="field half-width">
                                                    <div id="example2-card-cvc" class="input empty"></div>
                                                    <label for="example2-card-cvc" data-tid="elements_examples.form.card_cvc_label">{{ text_cvc }}</label>
                                                    <div class="baseline"></div>
                                                </div>
                                            </div>

                                            <div class="error" role="alert"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17">
                                                    <path class="base" fill="#000" d="M8.5,17 C3.80557963,17 0,13.1944204 0,8.5 C0,3.80557963 3.80557963,0 8.5,0 C13.1944204,0 17,3.80557963 17,8.5 C17,13.1944204 13.1944204,17 8.5,17 Z"></path>
                                                    <path class="glyph" fill="#FFF" d="M8.5,7.29791847 L6.12604076,4.92395924 C5.79409512,4.59201359 5.25590488,4.59201359 4.92395924,4.92395924 C4.59201359,5.25590488 4.59201359,5.79409512 4.92395924,6.12604076 L7.29791847,8.5 L4.92395924,10.8739592 C4.59201359,11.2059049 4.59201359,11.7440951 4.92395924,12.0760408 C5.25590488,12.4079864 5.79409512,12.4079864 6.12604076,12.0760408 L8.5,9.70208153 L10.8739592,12.0760408 C11.2059049,12.4079864 11.7440951,12.4079864 12.0760408,12.0760408 C12.4079864,11.7440951 12.4079864,11.2059049 12.0760408,10.8739592 L9.70208153,8.5 L12.0760408,6.12604076 C12.4079864,5.79409512 12.4079864,5.25590488 12.0760408,4.92395924 C11.7440951,4.59201359 11.2059049,4.59201359 10.8739592,4.92395924 L8.5,7.29791847 L8.5,7.29791847 Z"></path>
                                                </svg>
                                                <span class="message"></span>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                {% if use_stored_cards == '1' %}
                                    <div class="form-check save-card-checkbox-wrapper">
                                        <input type="checkbox" class="form-check-input" id="saveCardCheckbox">
                                        <label class="form-check-label" for="saveCardCheckbox">{{ text_save_card }}</label>
                                    </div>
                                {% endif %}


                            {% endif %}
                        </form>

                        {% if paymenttype_creditcards %}
                            <div class="success-stripe">
                                <div class="icon">
                                    <svg width="84px" height="84px" viewBox="0 0 84 84" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <circle class="border" cx="42" cy="42" r="40" stroke-linecap="round" stroke-width="4" stroke="#000" fill="none"></circle>
                                    </svg>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <input id="clientSecret" type="hidden" value="{{ intent.client_secret }}">
                    <input id="paymentIntent" type="hidden" value="{{ intent.id }}">
                </div>
            {% endif %}

            <!-- iDEAL -->
            {% if paymenttype_ideal %}
                <div class="tab-pane {{ ideal_tab }}" id="ideal" role="tabpanel" aria-labelledby="ideal-tab">
                </div>
            {% endif %}

            <!-- Giropay -->
            {% if paymenttype_giropay %}
                <div class="tab-pane {{ giropay_tab }}" id="giropay" role="tabpanel" aria-labelledby="giropay-tab">
                </div>
            {% endif %}

            <!-- Bancontact -->
            {% if paymenttype_bancontact %}
                <div class="tab-pane {{ bancontact_tab }}" id="bancontact" role="tabpanel" aria-labelledby="bancontact-tab">
                </div>
            {% endif %}

            <!-- EPS -->
            {% if paymenttype_eps %}
                <div class="tab-pane {{ eps_tab }}" id="eps" role="tabpanel" aria-labelledby="eps-tab">
                </div>
            {% endif %}

            <!-- P24 -->
            {% if paymenttype_p24 %}
                <div class="tab-pane {{ p24_tab }}" id="p24" role="tabpanel" aria-labelledby="p24-tab">
                </div>
            {% endif %}

            <!-- Multibanco -->
            {% if paymenttype_multibanco %}
                <div class="tab-pane {{ multibanco_tab }}" id="multibanco" role="tabpanel" aria-labelledby="multibanco-tab">
                </div>
            {% endif %}

            <!-- Klarna -->
            {% if paymenttype_klarna %}
                <div class="tab-pane {{ klarna_tab }}" id="klarna" role="tabpanel" aria-labelledby="klarna-tab">
                </div>
            {% endif %}

            <!-- WeChat -->
            {% if paymenttype_wechat %}
                <div class="tab-pane {{ wechat_tab }}" id="wechat" role="tabpanel" aria-labelledby="wechat-tab">
                    <div id="wechat-qrcode"></div>
                    <div id="msg-wechat">{{ msg_wechat }} {{ amount_formatted_wechat }}</div>
                </div>
            {% endif %}

            <!-- Alipay -->
            {% if paymenttype_alipay %}
                <div class="tab-pane {{ alipay_tab }}" id="alipay" role="tabpanel" aria-labelledby="alipay-tab">
                </div>
            {% endif %}

            <!-- FPX -->
            {% if paymenttype_fpx %}
                <div class="tab-pane {{ fpx_tab }}" id="fpx" role="tabpanel" aria-labelledby="fpx-tab">
                    <div id="fpx-bank-element" class="fpx-wrapper"></div>
                    <div id="fpx-error-message" style="display: none" role="alert">Please select a bank</div>
                </div>
            {% endif %}

        </div>
    </div>

    <!-- Common Confirm Button -->
    <div class="button-confirm-wrapper">
        <button type="button" id="button-confirm" class="btn-easystripe {{ button_css_classes }}" style="{{ button_styles }}">{{ text_submit_payment }} {{ amount_formatted }}</button>
    </div>

<!-- STRIPE CHECKOUT PAGE -->
{% else %}
    <div class="payment-form-wrapper type-checkout">
        <form id="payment-form">
            <button type="button" id="button-confirm" class="button-checkout-page">{{ text_submit_payment }} {{ amount_formatted }}</button>
        </form>
    </div>
{% endif %}


{% if paymenttype_wechat %}
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js" integrity="sha384-3zSEDfvllQohrq0PHL1fOXJuC/jSOO34H46t6UQfobFOmxE5BpjjaIJY5F2/bMnU" crossorigin="anonymous"></script>
{% endif %}

<style>
    {{ custom_css }}
</style>

<script type="text/javascript">
    if (!window.Stripe) {
        $.getScript("https://js.stripe.com/v3/");
    }
</script>

<script type="text/javascript" src="{{ b }}catalog/view/javascript/esp_index.js" ></script>


{# Global vars #}
<script type="text/javascript">
    var stripe = null;
    var form = null;
    var elements = null;
    var _bird = null;
    var fpxBank = null;
    var billingInfo = {{ billing|json_encode|raw }};
    var wechatCurrency = '{{ wechat_currency }}';
    var wechatAmount = '{{ wechat_amount }}';
    var alipayCurrency = '{{ alipay_currency }}';
    var alipayAmount = '{{ alipay_amount }}';
    var amountEur = '{{ amount_eur }}';
    var d19 = '{{ d19 }}';
    var orderId = '{{ order_id }}';
    var klarnaAmount = '{{ amount_klarna }}';
    var klarnaCurrency = '{{ klarna_cur }}';
    var firstName = "{{ first_name }}";
    var lastName = "{{ last_name }}";
    var amount = '{{ amount }}';
    var currency = '{{ currency }}';
    var urlBase = '{{ url_base }}';
    var b = '{{ b }}';
    var successUrl = '{{ success_url }}';
</script>


<script type="text/javascript">
    $('.btn-easystripe').click(function (e) {
        e.preventDefault();
        let method =  $('.nav-tabs li.active .nav-link').attr("data-value");
        if(method === undefined) {
            method =  $('.nav-tabs li .nav-link.active').attr("data-value");
        }

        const btn = $(this);
        if(method === 'storedcard') {
            btn.button('loading');
            btn.attr("disabled", true);
            btn.addClass('disabled');
            processStoredCard(urlBase);
        } else if(method === 'newcard') {
            processNewCard(urlBase);
        } else if(method === 'klarna') {
            btn.button('loading');
            btn.attr("disabled", true);
            btn.addClass('disabled');
            processSourcePaymentKlarna(klarnaAmount, klarnaCurrency, billingInfo, firstName, lastName, orderId, d19);
        } else if(method === 'wechat') {
            btn.button('loading');
            btn.attr("disabled", true);
            btn.addClass('disabled');
            processSourcePayment(method, wechatCurrency.toLowerCase(), wechatAmount, d19, orderId, billingInfo, urlBase);
        } else if(method === 'alipay') {
            btn.button('loading');
            btn.attr("disabled", true);
            btn.addClass('disabled');
            processSourcePayment('alipay', alipayCurrency.toLowerCase(), alipayAmount,  d19, orderId, billingInfo, urlBase);
        } else if(method === 'fpx') {
            if(fpxBank._empty) {
                $("#fpx-error-message").show();
                return;
            } else {
                $("#fpx-error-message").hide();
            }
            btn.button('loading');
            btn.attr("disabled", true);
            btn.addClass('disabled');
            processFPX(b, urlBase, fpxBank);
        } else if(method === 'multibanco') {
            btn.button('loading');
            btn.attr("disabled", true);
            btn.addClass('disabled');
            processSourcePaymentMultibanco(amountEur, orderId, billingInfo, successUrl, urlBase);
        } else {
            // bancontact, giropay, ideal, eps, p24
            btn.button('loading');
            btn.attr("disabled", true);
            btn.addClass('disabled');
            processSourcePayment(method, 'eur', amountEur, d19,  orderId, billingInfo, urlBase);
        }
    });
</script>


{# Init Stripe #}
<script type="text/javascript">
    console.log('{{ version }}');
    // if ($('.quick-checkout-payment').length) {
    //     $('.btn-easystripe').hide();
    //     $('.button-checkout-page').hide();
    // }

    function initStripeSafe() {
        console.log('===initStripeSafe');
        if (typeof initStripe !== "undefined") {
            initStripe('{{ public_key }}');
        } else {
            setTimeout(initStripeSafe, 50);
        }
    }
    initStripeSafe();

    // Patch custom checkout
    function patchCheckoutSafe() {
        if(!window.BirdCheckout) {
            setTimeout(patchCheckoutSafe, 50);
            return;
        }
        _bird = new window.BirdCheckout();
        console.log('module:', _bird.module);
        if(_bird.module === 'journal2') {
            const tabContent = $('#stripeproTabContent');
            const btnConfirm = $('.btn-easystripe');
            if(tabContent.length > 0) {
                tabContent[0].style.display = 'block';
            }
            if(btnConfirm.length > 0) {
                btnConfirm[0].style.display = 'none';
            }
        }
    }
    $( document ).ready(function() {
        patchCheckoutSafe();
    });
    // end patch
</script>


{% if checkout_type == 'payment_form' and paymenttype_fpx %}
    <script type="text/javascript">
        function initFPXSafe() {
            stripe != null ? fpxBank = initFPX()
                : setTimeout(function() { initFPXSafe() }, 50);
        }
        initFPXSafe();
    </script>
{% endif %}

{# Init elements, payment request button OR checkout page #}
{% if checkout_type == 'payment_form' %}
    {# Init Elements #}
    {% if paymenttype_creditcards and card_template == 'template1' %}
        <script type="text/javascript" src="{{ b }}catalog/view/javascript/esp_template1.js" ></script>
    {% elseif paymenttype_creditcards and card_template == 'template2' %}
        <script type="text/javascript" src="{{ b }}catalog/view/javascript/esp_template2.js" ></script>
    {% endif %}

    {# Init Payment Button #}
    {% if paymenttype_button %}
        <script type="text/javascript">
            function initPaymentRequestButtonSafe() {
                stripe != null ? initPaymentRequestButton(amount, currency, urlBase)
                    : setTimeout(function() { initPaymentRequestButtonSafe() }, 50);
            }
            initPaymentRequestButtonSafe();
        </script>
    {% endif %}

{% else %}
    <script type="text/javascript">
        function initTypeCheckoutPageSafe() {
            stripe != null ? initTypeCheckoutPage(urlBase)
                : setTimeout(function() { initTypeCheckoutPageSafe() }, 50);
        }
        initTypeCheckoutPageSafe();
    </script>
{% endif %}